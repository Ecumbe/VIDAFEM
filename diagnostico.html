<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Reporte - VIDAFEM</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/diagnostico.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <div class="overlay" id="overlay"></div>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="toggle-desktop" id="toggleDesktop"><i class="fas fa-chevron-left"></i></div>
        <div class="sidebar-header">
            <img src="assets/logo2.png" class="logo-icon" alt="VIDAFEM">
            <span class="brand-text">VIDAFEM</span>
        </div>
        <ul class="sidebar-menu">
            <li class="menu-item">
                <a href="admin.html" class="menu-link active btn-back-sidebar warning-link">
                    <i class="fas fa-arrow-left"></i> <span>Cancelar / Volver</span>
                </a>
            </li>
        </ul>
        <div style="margin-top: auto;">
            <li class="menu-item">
                <a href="#" class="menu-link warning-link" id="btnLogout">
                    <i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span>
                </a>
            </li>
        </div>
    </nav>

    <div class="main-wrapper">

        <!-- HEADER -->
        <header class="top-bar">
            <div class="toggle-mobile" id="toggleMobile"><i class="fas fa-bars"></i></div>
            <h2 class="page-title">Nuevo Reporte Clínico</h2>
        </header>

        <div class="dashboard-content">

            <!-- 1. TARJETA DE PACIENTE (TU DISEÑO ORIGINAL) -->
            <div class="card patient-header-card" style="margin-bottom: 25px; border-left: 5px solid var(--c-primary);">
                <div class="patient-avatar"><i class="fas fa-user"></i></div>
                <div class="patient-info-main">
                    <h2 id="displayNombre">Cargando datos...</h2>
                    <div class="patient-tags">
                        <span class="tag-age" id="displayEdad">-- años</span>
                        <span class="tag-id" id="displayCedula">C.I.: --</span>
                    </div>
                </div>
                <div class="patient-info-extra">
                    <div class="info-item">
                        <label>Fecha de Nacimiento</label>
                        <span id="displayNacimiento">--/--/----</span>
                    </div>
                    <input type="hidden" id="selectedPatientId">
                    <input type="hidden" id="patientNameDisplay">
                </div>
            </div>

            <!-- 2. SELECTOR DE SERVICIO -->
            <div class="section-box" style="margin-bottom: 20px; border-left: 5px solid #36235d;">
                <label style="font-weight:bold; color:#36235d; display:block; margin-bottom:5px;">Selecciona el
                    Servicio:</label>
                <select id="reportTypeSelector" class="doc-input" style="font-size:1.1rem; padding:10px; width:100%;"
                    onchange="toggleForm()">
                    <option value="" selected disabled>-- Seleccione un Servicio --</option>
                    <option value="colposcopia">COLPOSCOPIA</option>
                    <option value="general">CONSULTA GENERAL</option>
                    <!-- Opciones dinámicas se cargan aquí -->
                </select>
            </div>

            <!-- ======================================================= -->
            <!-- 3. ÁREA DE FORMULARIOS ESPECÍFICOS -->
            <!-- ======================================================= -->

            <!-- A. FORMULARIO COLPOSCOPÍA (TU DISEÑO ORIGINAL RESTAURADO) -->
            <div id="form-colposcopia" class="report-form hidden">
                <div class="paper-sheet">
                    <div style="text-align:right; margin-bottom:10px;">
                        <span
                            style="background:#e67e22; color:white; padding:5px 10px; border-radius:15px; font-size:0.8rem; font-weight:bold;">MODO
                            COLPOSCOPIA</span>
                    </div>
                    <h2 class="doc-title">REPORTE COLPOSCÓPICO</h2>

                    <div class="section-box">
                        <h4>EVALUACIÓN GENERAL</h4>
                        <textarea id="colpo_evaluacion" rows="3" class="doc-input"
                            placeholder="Descripción de la zona de transformación..."></textarea>
                        <div class="check-grid">
                            <label>VAGINA: <select id="colpo_vagina" class="tiny-select">
                                    <option>Normal</option>
                                    <option>Anormal</option>
                                </select></label>
                            <label>VULVA: <select id="colpo_vulva" class="tiny-select">
                                    <option>Normal</option>
                                    <option>Anormal</option>
                                </select></label>
                            <label>ANO: <select id="colpo_ano" class="tiny-select">
                                    <option>Normal</option>
                                    <option>Anormal</option>
                                </select></label>
                        </div>
                    </div>

                    <div class="section-box">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h4>EVIDENCIA FOTOGRÁFICA</h4>
                            <button type="button" onclick="addPhotoSlot()"
                                style="background:#e67e22; color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; font-weight:bold;">
                                <i class="fas fa-plus-circle"></i> Agregar Foto
                            </button>
                        </div>
                        <div id="dynamicPhotoContainer" class="photo-grid-dynamic"></div>
                    </div>

                    <div class="section-box">
                        <h4>HALLAZGOS Y DIAGNÓSTICO</h4>
                        <div class="form-group"><label>Hallazgos:</label><textarea id="colpo_hallazgos" rows="3"
                                class="doc-input"></textarea></div>
                        <div class="form-group"><label>Diagnóstico:</label><textarea id="colpo_diagnostico" rows="2"
                                class="doc-input"></textarea></div>
                        <div class="form-group"><label>Biopsia:</label><input type="text" id="colpo_biopsia"
                                class="doc-input"></div>
                    </div>

                    <div class="section-box" style="border:none;">
                        <h4>RECOMENDACIONES</h4>
                        <textarea id="colpo_recomendaciones" rows="4" class="doc-input"></textarea>
                    </div>
                </div>
            </div>

            <!-- B. FORMULARIO RECETA EXCLUSIVA (Original) -->
            <div id="form-receta" class="report-form hidden">
                <div class="paper-sheet">
                    <div style="text-align:right; margin-bottom:10px;">
                        <span
                            style="background:#27ae60; color:white; padding:5px 10px; border-radius:15px; font-size:0.8rem; font-weight:bold;">MODO
                            RECETA</span>
                    </div>
                    <h2 class="doc-title" style="color:#27ae60;">RECETA MÉDICA</h2>
                    <div class="section-box">
                        <table id="medicationTable" style="width:100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background:#f8f9fa; text-align:left;">
                                    <th style="padding:10px;">Medicamento</th>
                                    <th style="padding:10px; width:100px;">Cant.</th>
                                    <th style="padding:10px;">Indicaciones</th>
                                    <th style="width:50px;"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <button type="button" onclick="addMedRow()"
                            style="margin-top:15px; background:#e8f5e9; color:#27ae60; border:1px solid #27ae60; padding:8px 15px; cursor:pointer; border-radius:6px; font-weight:bold;"><i
                                class="fas fa-plus"></i> Agregar Medicamento</button>
                    </div>
                    <div class="form-group">
                        <label>Observaciones Adicionales:</label>
                        <textarea id="receta_observaciones" rows="3" class="doc-input"></textarea>
                    </div>
                </div>
            </div>

            <!-- C. FORMULARIO GENERAL (Original) -->
            <div id="form-general" class="report-form hidden">
                <div class="paper-sheet">
                    <div style="text-align:right; margin-bottom:10px;">
                        <span
                            style="background:#3498db; color:white; padding:5px 10px; border-radius:15px; font-size:0.8rem; font-weight:bold;">CONSULTA
                            GENERAL</span>
                    </div>
                    <h2 class="doc-title" style="color:#3498db;">EVOLUCIÓN CLÍNICA</h2>

                    <div class="section-box">
                        <div class="form-group">
                            <label>Motivo de Consulta:</label>
                            <textarea id="gen_motivo" rows="2" class="doc-input"
                                placeholder="Razón de la visita..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Evolución / Examen Físico:</label>
                            <textarea id="gen_evaluacion" rows="5" class="doc-input"
                                placeholder="Descripción subjetiva y objetiva..."></textarea>
                        </div>
                    </div>

                    <div class="section-box">
                        <div class="form-group">
                            <label>Diagnóstico (CIE-10 / Presuntivo):</label>
                            <textarea id="gen_diagnostico" rows="2" class="doc-input"></textarea>
                        </div>
                    </div>

                    <div class="section-box" style="border:none;">
                        <h4>PLAN / TRATAMIENTO</h4>
                        <textarea id="gen_recomendaciones" rows="4" class="doc-input"
                            placeholder="Indicaciones para el paciente..."></textarea>
                    </div>
                </div>
            </div>

            <!-- D. FORMULARIO DINÁMICO (Para nuevos servicios) -->
            <div id="form-dinamico" class="hidden"
                style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fff; margin-bottom: 20px;">
                <h4 style="color: #666; text-align: center;">Cargando formulario...</h4>
            </div>

            <!-- ======================================================= -->
            <!-- 4. ZONA UNIVERSAL (Receta y PDF) - SIEMPRE VISIBLE AL FINAL -->
            <!-- ======================================================= -->
            <div id="zona-universal" style="margin-top: 30px; border-top: 4px solid #36235d; padding-top: 25px;">

                <button id="btnOpenReceta" type="button" class="btn-submit"
                    style="background:#27ae60; width:100%; margin-bottom:15px;" onclick="toggleRecetaModule(true)">
                    <i class="fas fa-prescription-bottle-alt"></i> AGREGAR RECETA MÉDICA
                </button>

                <div id="recetaUniversalContainer" class="card mb-3 hidden"
                    style="border: 1px solid #27ae60; background: white; border-radius: 5px; margin-bottom: 20px;">
                    <div class="card-header"
                        style="background: #e8f5e9; color: #27ae60; font-weight: bold; padding: 10px; display:flex; justify-content:space-between; align-items:center;">
                        <span><i class="fas fa-prescription-bottle-alt"></i> RECETA MÉDICA</span>
                        <button type="button" onclick="toggleRecetaModule(false)"
                            style="color:#c0392b; border:none; background:none; cursor:pointer; font-weight:bold;">
                            <i class="fas fa-times"></i> Quitar
                        </button>
                    </div>

                    <div style="padding: 15px;">
                        <table class="table" id="tablaRecetaUniversal"
                            style="width:100%; margin-bottom: 10px; border-collapse: collapse;">
                            <thead>
                                <tr style="background:#f0f0f0; text-align: left; border-bottom: 2px solid #ddd;">
                                    <th style="padding:8px;">Medicamento</th>
                                    <th style="padding:8px;" width="15%">Cant.</th>
                                    <th style="padding:8px;">Indicaciones</th>
                                    <th width="5%"></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>

                        <button type="button" class="btn-submit"
                            style="background:#27ae60; width:auto; padding: 8px 15px; font-size:0.9rem;"
                            onclick="addMedRowUniversal()">
                            <i class="fas fa-plus"></i> Agregar Fila
                        </button>

                        <textarea id="receta_obs_universal" class="doc-input mt-2"
                            placeholder="Observaciones generales de la receta (Opcional)..." rows="2"
                            style="margin-top:15px; width: 100%; box-sizing: border-box;"></textarea>
                    </div>
                </div>

                <button id="btnOpenPdf" type="button" class="btn-submit"
                    style="background:#3498db; width:100%; margin-bottom:15px;" onclick="togglePdfModule(true)">
                    <i class="fas fa-paperclip"></i> ADJUNTAR EXAMEN / PDF
                </button>

                <div id="pdfUploadContainer" class="card mb-3 hidden"
                    style="border: 1px solid #2980b9; margin-top: 20px; background: white; border-radius: 5px;">
                    <div class="card-header"
                        style="background: #eaf2f8; color: #2980b9; font-weight: bold; padding: 10px; display:flex; justify-content:space-between; align-items:center;">
                        <span><i class="fas fa-paperclip"></i> ARCHIVO ADJUNTO</span>
                        <button type="button" onclick="togglePdfModule(false)"
                            style="color:#c0392b; border:none; background:none; cursor:pointer; font-weight:bold;">
                            <i class="fas fa-times"></i> Quitar
                        </button>
                    </div>
                    <div style="padding: 15px;">
                        <div id="existingPdfMsg"></div>

                        <label style="font-size: 0.9em; color: #666; display:block; margin-bottom:5px;">Si tienes un
                            resultado de laboratorio o un PDF externo, súbelo aquí:</label>
                        <input type="file" id="pdfExternoFile" accept="application/pdf" class="doc-input"
                            style="width: 100%;">
                        <small style="color: #888;">Este archivo se guardará en la carpeta del paciente.</small>
                    </div>
                </div>

            </div>

            <!-- ======================================================= -->
            <!-- 5. BOTONES DE ACCIÓN (Unificados para todo) -->
            <!-- ======================================================= -->
            <div class="editor-footer" style="margin-top: 30px; display:flex; gap:15px; padding-bottom: 50px;">
                <button onclick="handleMasterSave(false, this)" class="btn-submit btn-save-main"
                    style="background:#7f8c8d; flex:1; cursor: pointer; padding: 15px;">
                    <i class="fas fa-save"></i> Solo Guardar
                </button>
                <button onclick="handleMasterSave(true, this)" class="btn-submit btn-save-main"
                    style="background:#36235d; flex:1; cursor: pointer; padding: 15px;">
                    <i class="fas fa-print"></i> Guardar y Generar PDF
                </button>
            </div>

        </div>
    </div>

    <!-- MODAL EDITOR DE FOTOS -->
    <div class="overlay" id="editorOverlay"></div>
    <div class="editor-modal" id="photoEditor">
        <div class="editor-header">
            <h3>Editor de Imagen</h3>
            <button onclick="closeEditor()" class="btn-close"
                style="background:none; border:none; font-size:1.5rem; cursor:pointer;"><i
                    class="fas fa-times"></i></button>
        </div>
        <div class="editor-toolbar-top">
            <button class="tool-btn active" onclick="setTool('brush', this)"><i class="fas fa-pencil-alt"></i></button>
            <button class="tool-btn" onclick="setTool('circle', this)"><i class="far fa-circle"></i></button>
            <button class="tool-btn" onclick="setTool('arrow', this)"><i
                    class="fas fa-long-arrow-alt-right"></i></button>
            <button class="tool-btn" onclick="addTextToCanvas(this)"><i class="fas fa-font"></i></button>
        </div>
        <div class="editor-body">
            <canvas id="drawingCanvas"></canvas>
        </div>
        <div class="editor-toolbar">
            <div class="toolbar-group">
                <button class="color-btn active" onclick="setToolColor('#ff0000', this)"
                    style="background:#ff0000;"></button>
                <button class="color-btn" onclick="setToolColor('#2ecc71', this)" style="background:#2ecc71;"></button>
                <button class="color-btn" onclick="setToolColor('#3498db', this)" style="background:#3498db;"></button>
                <button class="color-btn" onclick="setToolColor('#f1c40f', this)" style="background:#f1c40f;"></button>
                <button class="color-btn" onclick="setToolColor('#ffffff', this)"
                    style="background:#ffffff; border:1px solid #ccc;"></button>
                <button class="color-btn" onclick="setToolColor('#000000', this)" style="background:#000000;"></button>
            </div>
            <div class="toolbar-group">
                <button class="tool-btn" onclick="undoLastStroke()"><i class="fas fa-undo"></i></button>
                <button class="tool-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i></button>
            </div>
        </div>
        <div class="editor-footer">
            <button onclick="saveEditedPhoto()" class="btn-submit"
                style="background:#36235d; width:100%; cursor: pointer;">
                <i class="fas fa-check"></i> Guardar Edición
            </button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="js/config.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/diagnostico.js"></script>

</body>

</html>